<script>
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));

  const STORAGE_KEY = "focus_dashboard_fixed";

  function pad2(n){ return String(n).padStart(2,"0"); }
  function todayKey() {
    const d = new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }

  function loadState(){
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; }
    catch(e){ return {}; }
  }
  function saveState(state){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }
  function getState(){
    const s = loadState();
    if(!s.daily) s.daily = {};
    if(!s.daily[todayKey()]) s.daily[todayKey()] = {};
    if(!s.meta) s.meta = {};
    if(!s.journals) s.journals = {};
    return s;
  }

  // ✅ 체크박스 선택: data-key 우선, 없으면 전체 체크박스
  function allBoxes(){
    const keyed = $$("input[type='checkbox'][data-key]");
    if (keyed.length > 0) return keyed;
    return $$("input[type='checkbox']");
  }

  function boxKey(box, idx){
    return box.dataset.key || `box_${idx}`;
  }

  function setDaily(key, value){
    const s = getState();
    s.daily[todayKey()][key] = !!value;
    saveState(s);
  }

  function getDaily(key){
    const s = getState();
    return !!(s.daily?.[todayKey()]?.[key]);
  }

  function setMeta(key, value){
    const s = getState();
    s.meta[key] = value;
    saveState(s);
  }

  function getMeta(key){
    const s = getState();
    return s.meta?.[key] || "";
  }

  // ===== 진행률 =====
  function updateProgress(){
    const boxes = allBoxes();
    const total = boxes.length;
    const done = boxes.filter(b => b.checked).length;
    const pct = total === 0 ? 0 : Math.round((done/total)*100);

    const totalEl = $("#total");
    const doneEl = $("#done");
    const pctEl = $("#percent");
    const barEl = $("#progressBar");

    if (totalEl) totalEl.textContent = total;
    if (doneEl) doneEl.textContent = done;
    if (pctEl) pctEl.textContent = pct + "%";
    if (barEl) barEl.style.width = pct + "%";
  }

  function init(){
    const dateLabel = $("#dateLabel");
    if (dateLabel) dateLabel.textContent = todayKey();

    // 체크박스 바인딩
    const boxes = allBoxes();
    boxes.forEach((box, idx) => {
      const k = boxKey(box, idx);
      box.checked = getDaily(k);
      box.addEventListener("change", () => {
        setDaily(k, box.checked);
        updateProgress();
      });
    });

    // 메모/목표/링크(있으면만)
    const topGoal = $("#topGoal");
    const note = $("#note");
    if (topGoal) {
      topGoal.value = getMeta("topGoal");
      topGoal.addEventListener("input", (e)=>setMeta("topGoal", e.target.value));
    }
    if (note) {
      note.value = getMeta("note");
      note.addEventListener("input", (e)=>setMeta("note", e.target.value));
    }
    ["link1","link2","link3","link4"].forEach(id=>{
      const el = $("#"+id);
      if(!el) return;
      el.value = getMeta(id);
      el.addEventListener("input", (e)=>setMeta(id, e.target.value));
    });

    // 버튼(있으면만)
    const btnToday = $("#btnToday");
    if (btnToday) {
      btnToday.addEventListener("click", () => {
        const s = getState();
        s.daily[todayKey()] = {};
        saveState(s);
        allBoxes().forEach(b => b.checked = false);
        updateProgress();
      });
    }

    const btnClear = $("#btnClear");
    if (btnClear) {
      btnClear.addEventListener("click", () => {
        if (!confirm("전체 데이터(체크/메모/링크)를 초기화할까요?")) return;
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
      });
    }

    const btnOpenLinks = $("#btnOpenLinks");
    if (btnOpenLinks) {
      btnOpenLinks.addEventListener("click", () => {
        const urls = ["link1","link2","link3","link4"]
          .map(id => ($("#"+id)?.value || "").trim())
          .filter(u => u.length > 0);
        if (urls.length === 0) return alert("열 링크가 없어요. URL을 먼저 적어주세요.");
        urls.forEach(u => window.open(u, "_blank"));
      });
    }

    const btnExport = $("#btnExport");
    if (btnExport) {
      btnExport.addEventListener("click", () => {
        const data = loadState();
        const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "focus-dashboard-backup.json";
        a.click();
        URL.revokeObjectURL(a.href);
      });
    }

    updateProgress();
  }

  init();
</script>