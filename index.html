<script>
/* ================== íƒ­ ì „í™˜ ================== */
const tabRoutine = document.getElementById("tabRoutine");
const tabBeauty  = document.getElementById("tabBeauty");
const pageRoutine = document.getElementById("pageRoutine");
const pageBeauty  = document.getElementById("pageBeauty");

function showRoutine(){
  pageRoutine.classList.add("active");
  pageBeauty.classList.remove("active");
  tabRoutine.classList.add("active");
  tabBeauty.classList.remove("active");
  window.scrollTo(0,0);
}
function showBeauty(){
  pageBeauty.classList.add("active");
  pageRoutine.classList.remove("active");
  tabBeauty.classList.add("active");
  tabRoutine.classList.remove("active");
  window.scrollTo(0,0);
}
tabRoutine.addEventListener("click", showRoutine);
tabBeauty.addEventListener("click", showBeauty);

/* ============== ê³µìš© ëŒ€ì‹œë³´ë“œ (prefix ê¸°ë°˜) ============== */
function createDashboard(prefix, storageKey){
  const todayKey = () => {
    const d = new Date();
    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
    return d.toISOString().slice(0, 10);
  };

  const pad2 = n => String(n).padStart(2,"0");
  const ymd  = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const sameDay = (a,b) => a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
  const escapeHtml = s => (s||"").replace(/</g,"&lt;");

  function load(){
    try { return JSON.parse(localStorage.getItem(storageKey) || "{}"); }
    catch(e){ return {}; }
  }
  function save(v){ localStorage.setItem(storageKey, JSON.stringify(v)); }

  const state = load();
  if(!state.daily) state.daily = {};
  if(!state.journals) state.journals = {};
  if(!state.lifePlans) state.lifePlans = {};
  if(!state.positiveMemos) state.positiveMemos = {};
  if(!state.esteemMemos) state.esteemMemos = {};

  function pageRoot(){
    return document.getElementById(prefix==="r" ? "pageRoutine" : "pageBeauty");
  }
  function boxes(){
    return Array.from(pageRoot().querySelectorAll('input[type=checkbox][data-key]'));
  }
  function keysList(){ return boxes().map(b => b.dataset.key); }

  const dateLabel = document.getElementById(prefix+"_dateLabel");
  const journal   = document.getElementById(prefix+"_journal");
  const lifePlan  = document.getElementById(prefix+"_lifePlan");

  // ë£¨í‹´ ì „ìš© ë©”ëª¨(ê¸ì •/ìì¡´ê°)
  const positiveMemo = (prefix==="r") ? document.getElementById("r_positiveMemo") : null;
  const esteemMemo   = (prefix==="r") ? document.getElementById("r_esteemMemo")   : null;

  // âœ… í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ë‚ ì§œ
  let activeDate = todayKey();
  if(!state.daily[activeDate]) state.daily[activeDate] = {};

  function updateProgressForActiveDate(){
    const b = boxes();
    const total = b.length;
    const done  = b.filter(x => x.checked).length;
    const pct   = total ? Math.round(done/total*100) : 0;

    const doneEl = document.getElementById(prefix+"_done");
    const totEl  = document.getElementById(prefix+"_total");
    const pctEl  = document.getElementById(prefix+"_percent");
    const barEl  = document.getElementById(prefix+"_bar");

    if(doneEl) doneEl.textContent = done;
    if(totEl)  totEl.textContent  = total;
    if(pctEl)  pctEl.textContent  = pct + "%";
    if(barEl)  barEl.style.width  = pct + "%";
  }

  function setActiveDate(dateStr){
    activeDate = dateStr;
    if(!state.daily[activeDate]) state.daily[activeDate] = {};

    if(dateLabel) dateLabel.textContent = activeDate;

    // ì²´í¬ë°•ìŠ¤ ë¡œë“œ
    boxes().forEach(b=>{
      const k = b.dataset.key;
      b.checked = !!(state.daily[activeDate] && state.daily[activeDate][k]);
    });

    // í…ìŠ¤íŠ¸ ë¡œë“œ
    if(journal) journal.value = state.journals[activeDate] || "";
    if(lifePlan) lifePlan.value = state.lifePlans[activeDate] || "";

    // ë£¨í‹´ ì „ìš© ë©”ëª¨ ë¡œë“œ
    if(positiveMemo) positiveMemo.value = state.positiveMemos[activeDate] || "";
    if(esteemMemo)   esteemMemo.value   = state.esteemMemos[activeDate] || "";

    updateProgressForActiveDate();
  }

  // âœ… ìµœì´ˆ ë¡œë“œ
  setActiveDate(activeDate);

  // ì²´í¬ë°•ìŠ¤ ë°”ì¸ë”© (activeDateì— ì €ì¥)
  boxes().forEach(b=>{
    const k = b.dataset.key;
    b.addEventListener("change", ()=>{
      state.daily[activeDate][k] = b.checked;
      save(state);
      updateProgressForActiveDate();
      renderAnalytics();
    });
  });

  // ì¼ê¸° ì €ì¥
  if(journal){
    journal.addEventListener("input", ()=>{
      state.journals[activeDate] = journal.value;
      save(state);
    });
  }

  // ì¸ìƒ ê³„íš ì €ì¥(ë£¨í‹´ë§Œ ìˆì–´ë„ ì•ˆì „)
  if(lifePlan){
    lifePlan.addEventListener("input", ()=>{
      state.lifePlans[activeDate] = lifePlan.value;
      save(state);
    });
  }

  // ê¸ì •/ìì¡´ê° ë©”ëª¨ ì €ì¥(ë£¨í‹´ë§Œ)
  if(positiveMemo){
    positiveMemo.addEventListener("input", ()=>{
      state.positiveMemos[activeDate] = positiveMemo.value;
      save(state);
    });
  }
  if(esteemMemo){
    esteemMemo.addEventListener("input", ()=>{
      state.esteemMemos[activeDate] = esteemMemo.value;
      save(state);
    });
  }

  // ëª©ë¡ ë Œë”
  function renderTextList(targetId, mapObj, kindLabel){
    const box = document.getElementById(targetId);
    if(!box) return;

    const entries = Object.entries(mapObj || {})
      .filter(([d, txt]) => (txt||"").trim().length > 0)
      .sort((a,b)=> b[0].localeCompare(a[0]));

    if(entries.length === 0){
      box.innerHTML = `<div class="small">ì•„ì§ ì €ì¥ëœ ê¸°ë¡ì´ ì—†ì–´ìš”.</div>`;
      return;
    }

    box.innerHTML = entries.map(([d, txt]) => `
      <div class="listCard">
        <div class="topbar" style="padding:0;margin:0;border:0">
          <b>${d}</b>
          <button class="btn danger" type="button" data-del="${d}">ì‚­ì œ</button>
        </div>
        <pre>${escapeHtml(txt)}</pre>
      </div>
    `).join("");

    box.querySelectorAll("button[data-del]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const d = btn.getAttribute("data-del");
        if(!confirm(`${d} ${kindLabel} ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?`)) return;
        delete mapObj[d];
        save(state);
        renderTextList(targetId, mapObj, kindLabel);
        renderAnalytics();
      });
    });
  }

  // ë¦¬ìŠ¤íŠ¸ ë²„íŠ¼
  const btnDiaryList = document.getElementById(prefix+"_btnDiaryList");
  if(btnDiaryList){
    btnDiaryList.addEventListener("click", ()=>{
      const box = document.getElementById(prefix+"_diaryList");
      const open = box.style.display !== "none";
      box.style.display = open ? "none" : "block";
      if(!open) renderTextList(prefix+"_diaryList", state.journals, "ì¼ê¸°/ë©”ëª¨");
    });
  }

  // ë°±ì—…(JSON) - âœ… ê¸ì •/ìì¡´ê°ë„ í¬í•¨
  const btnDiaryExport = document.getElementById(prefix+"_btnDiaryExport");
  if(btnDiaryExport){
    btnDiaryExport.addEventListener("click", ()=>{
      const data = {
        daily: state.daily || {},
        journals: state.journals || {},
        lifePlans: state.lifePlans || {},
        positiveMemos: state.positiveMemos || {},
        esteemMemos: state.esteemMemos || {}
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = (prefix==="r" ? "routine" : "beauty") + "-dashboard-backup.json";
      a.click();
      URL.revokeObjectURL(a.href);
    });
  }

  // ì¸ìƒ ê³„íš ë¦¬ìŠ¤íŠ¸/ë°±ì—…(ë£¨í‹´ë§Œ)
  const btnLPList = document.getElementById(prefix+"_btnLifePlanList");
  if(btnLPList){
    btnLPList.addEventListener("click", ()=>{
      const box = document.getElementById(prefix+"_lifePlanList");
      const open = box.style.display !== "none";
      box.style.display = open ? "none" : "block";
      if(!open) renderTextList(prefix+"_lifePlanList", state.lifePlans, "ì¸ìƒ ê³„íš");
    });
  }
  const btnLPExport = document.getElementById(prefix+"_btnLifePlanExport");
  if(btnLPExport){
    btnLPExport.addEventListener("click", ()=>{
      const data = { lifePlans: state.lifePlans || {} };
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "lifeplan-backup.json";
      a.click();
      URL.revokeObjectURL(a.href);
    });
  }

  // ì˜¤ëŠ˜ë¡œ
  const btnGoToday = document.getElementById(prefix+"_btnGoToday");
  if(btnGoToday){
    btnGoToday.addEventListener("click", ()=>{
      setActiveDate(todayKey());
      renderAnalytics();
      window.scrollTo(0,0);
    });
  }

  // í˜„ì¬ í¸ì§‘ ë‚ ì§œë§Œ ë¦¬ì…‹
  const btnTodayReset = document.getElementById(prefix+"_btnTodayReset");
  if(btnTodayReset){
    btnTodayReset.addEventListener("click", ()=>{
      if(!confirm("í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ë‚ ì§œì˜ ì²´í¬/ê¸°ë¡ë§Œ ë¦¬ì…‹í• ê¹Œìš”?")) return;

      state.daily[activeDate] = {};
      state.journals[activeDate] = "";
      state.lifePlans[activeDate] = "";
      state.positiveMemos[activeDate] = "";
      state.esteemMemos[activeDate] = "";
      save(state);

      setActiveDate(activeDate);
      renderAnalytics();
    });
  }

  // ì „ì²´ ì´ˆê¸°í™”
  const btnClearAll = document.getElementById(prefix+"_btnClearAll");
  if(btnClearAll){
    btnClearAll.addEventListener("click", ()=>{
      if(!confirm("ì „ì²´ ë°ì´í„°(ì²´í¬/ê¸°ë¡)ë¥¼ ëª¨ë‘ ì´ˆê¸°í™”í• ê¹Œìš”?")) return;
      localStorage.removeItem(storageKey);
      location.reload();
    });
  }

  function progressOf(dateStr){
    const keys = keysList();
    const daily = (state.daily && state.daily[dateStr]) ? state.daily[dateStr] : {};
    const total = keys.length;
    const done  = keys.filter(k => !!daily[k]).length;
    const pct   = total ? Math.round(done/total*100) : 0;
    const hasData = daily && Object.keys(daily).length > 0;
    return { total, done, pct, hasData };
  }

  function startOfWeekMonday(d){
    const day = d.getDay();
    const diff = (day === 0) ? -6 : (1 - day);
    const s = new Date(d);
    s.setDate(s.getDate() + diff);
    s.setHours(0,0,0,0);
    return s;
  }

  function weekStats(){
    const today = new Date();
    const start = startOfWeekMonday(today);
    let sum = 0, count = 0;
    for(let i=0;i<7;i++){
      const d = new Date(start);
      d.setDate(start.getDate()+i);
      const ds = ymd(d);
      const p = progressOf(ds);
      sum += p.pct;
      if(p.hasData) count++;
    }
    return { avg: Math.round(sum/7), count };
  }

  let calYear = new Date().getFullYear();
  let calMonth0 = new Date().getMonth();

  function monthStats(year, month0){
    const last = new Date(year, month0+1, 0);
    let sum = 0;
    let cntDaysWithData = 0;
    for(let day=1; day<=last.getDate(); day++){
      const ds = ymd(new Date(year, month0, day));
      const p = progressOf(ds);
      sum += p.pct;
      if(p.hasData) cntDaysWithData++;
    }
    return { avg: Math.round(sum / last.getDate()), cntDaysWithData };
  }

  function renderWeekBars(){
    const el = document.getElementById(prefix+"_weekBars");
    if(!el) return;
    const today = new Date();
    const parts = [];
    for(let i=6;i>=0;i--){
      const d = new Date(today);
      d.setDate(today.getDate()-i);
      const ds = ymd(d);
      const p = progressOf(ds);
      const isToday = (ds === todayKey());
      parts.push(`
        <div class="barbox" title="${ds} (${p.pct}%)" style="${isToday ? "box-shadow:0 0 0 2px rgba(124,92,255,.25) inset" : ""}">
          <i style="height:${p.pct}%;"></i>
          <span>${ds.slice(8,10)}ì¼</span>
        </div>
      `);
    }
    el.innerHTML = parts.join("");
  }

  function renderCalendar(){
    const grid = document.getElementById(prefix+"_calGrid");
    const label = document.getElementById(prefix+"_calLabel");
    if(!grid || !label) return;

    label.textContent = `ì›”ê°„ ë‹¬ë ¥ Â· ${calYear}-${pad2(calMonth0+1)}`;

    const first = new Date(calYear, calMonth0, 1);
    const last  = new Date(calYear, calMonth0+1, 0);
    const startDow = first.getDay();
    const dows = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];

    const cells = [];
    for(const d of dows){ cells.push(`<div class="dow">${d}</div>`); }
    for(let i=0;i<startDow;i++){
      cells.push(`<div style="min-height:56px;opacity:.25;border:1px solid rgba(255,255,255,.06);border-radius:12px"></div>`);
    }

    const today = new Date();
    for(let day=1; day<=last.getDate(); day++){
      const d = new Date(calYear, calMonth0, day);
      const ds = ymd(d);
      const p = progressOf(ds);
      const alpha = 0.10 + (p.pct/100)*0.35;
      const isToday = sameDay(d,today);

      cells.push(`
        <button type="button" class="cell" data-date="${ds}"
          style="background:rgba(124,92,255,${alpha}); ${isToday ? "box-shadow:0 0 0 2px rgba(124,92,255,.25) inset;border-color:rgba(124,92,255,.55)" : ""}">
          <div class="d">${day}ì¼</div>
          <div class="p">${p.pct}%</div>
        </button>
      `);
    }

    grid.innerHTML = cells.join("");
    grid.querySelectorAll("button[data-date]").forEach(btn=>{
      btn.addEventListener("click", ()=> openDayModal(btn.getAttribute("data-date")));
    });
  }

  // ===== ëª¨ë‹¬ =====
  function openDayModal(dateStr){
    const back = document.getElementById(prefix+"_dayModalBackdrop");
    const title = document.getElementById(prefix+"_dayModalTitle");
    const pctEl = document.getElementById(prefix+"_dayModalPct");
    const doneEl = document.getElementById(prefix+"_dayModalDone");
    const totalEl = document.getElementById(prefix+"_dayModalTotal");
    const journalEl = document.getElementById(prefix+"_dayModalJournal");

    if(!back || !title || !pctEl || !doneEl || !totalEl || !journalEl) return;

    const p = progressOf(dateStr);
    title.textContent = `ğŸ“… ${dateStr}`;
    pctEl.textContent = `${p.pct}%`;
    doneEl.textContent = p.done;
    totalEl.textContent = p.total;

    let text = (state.journals && state.journals[dateStr]) ? state.journals[dateStr] : "(ê¸°ë¡ ì—†ìŒ)";

    // ë£¨í‹´ì´ë©´ ê¸ì •/ìì¡´ê°ë„ ê°™ì´ ë³´ì—¬ì£¼ê¸°
    if(prefix==="r"){
      const pos = state.positiveMemos?.[dateStr];
      const est = state.esteemMemos?.[dateStr];
      if(pos && pos.trim()) text += "\n\nğŸŒ± ê¸ì •ì  ìƒê°\n" + pos;
      if(est && est.trim()) text += "\n\nğŸ’– ìì¡´ê° ë©”ëª¨\n" + est;
    }

    journalEl.textContent = text;

    const lifePlanModal = document.getElementById(prefix+"_dayModalLifePlan");
    if(lifePlanModal){
      lifePlanModal.textContent = (state.lifePlans && state.lifePlans[dateStr]) ? state.lifePlans[dateStr] : "(ê¸°ë¡ ì—†ìŒ)";
    }

    const editBtn = document.getElementById(prefix+"_btnEditThisDay");
    if(editBtn){
      editBtn.onclick = ()=>{
        setActiveDate(dateStr);
        closeDayModal();
        window.scrollTo(0,0);
      };
    }

    back.style.display = "flex";
  }

  function closeDayModal(){
    const back = document.getElementById(prefix+"_dayModalBackdrop");
    if(back) back.style.display = "none";
  }

  const btnClose = document.getElementById(prefix+"_btnCloseDayModal");
  if(btnClose) btnClose.addEventListener("click", closeDayModal);

  const back = document.getElementById(prefix+"_dayModalBackdrop");
  if(back){
    back.addEventListener("click", (e)=>{
      if(e.target && e.target.id === (prefix+"_dayModalBackdrop")) closeDayModal();
    });
  }

  const btnPrev = document.getElementById(prefix+"_btnPrevMonth");
  const btnNext = document.getElementById(prefix+"_btnNextMonth");
  const btnThis = document.getElementById(prefix+"_btnThisMonth");

  if(btnPrev) btnPrev.addEventListener("click", ()=>{
    calMonth0--; if(calMonth0<0){ calMonth0=11; calYear--; }
    renderAnalytics();
  });
  if(btnNext) btnNext.addEventListener("click", ()=>{
    calMonth0++; if(calMonth0>11){ calMonth0=0; calYear++; }
    renderAnalytics();
  });
  if(btnThis) btnThis.addEventListener("click", ()=>{
    const n=new Date(); calYear=n.getFullYear(); calMonth0=n.getMonth();
    renderAnalytics();
  });

  function renderAnalytics(){
    const w = weekStats();
    const wAvg = document.getElementById(prefix+"_weekAvg");
    const wDays = document.getElementById(prefix+"_weekDays");
    if(wAvg) wAvg.textContent = `${w.avg}%`;
    if(wDays) wDays.textContent = `ê¸°ë¡ ${w.count}ì¼`;

    const m = monthStats(calYear, calMonth0);
    const mAvg = document.getElementById(prefix+"_monthAvg");
    const mDays = document.getElementById(prefix+"_monthDays");
    if(mAvg) mAvg.textContent = `${m.avg}%`;
    if(mDays) mDays.textContent = `ê¸°ë¡ ${m.cntDaysWithData}ì¼`;

    renderWeekBars();
    renderCalendar();
  }

  renderAnalytics();
  updateProgressForActiveDate();
}

/* ===== ë‘ ëŒ€ì‹œë³´ë“œ ìƒì„± (v5 í‚¤ ìœ ì§€) ===== */
createDashboard("r", "focus_dashboard_routine_v5");
createDashboard("b", "focus_dashboard_beauty_v5");
</script>